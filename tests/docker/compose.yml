services:
  mocks:
    image: outofcoffee/imposter:3.25.1
    volumes:
      - "../imposter:/opt/imposter/config"
    ports:
      - "8050:8080"
    network_mode: "host"

  web:
    build:
      context: ../..
      dockerfile: local.Dockerfile
    environment:
      REDIS_SESSION_URL: db
      API_BASE_URL: http://localhost:8080
      PORT: 5050
      NODE_ENV: development
      LANGUAGE_TOGGLE_DISABLED: false
      DEVICE_INTELLIGENCE_ENABLED: true
      DEVICE_INTELLIGENCE_DOMAIN: localhost
    ports:
      - "5050:5050"
    depends_on:
      - mocks
    network_mode: "host"

  cucumber:
    build:
      context: ../browser
      dockerfile: pre-merge.Dockerfile
    environment:
      USE_LOCAL_API: true
      GITHUB_ACTIONS: true
      WEBSITE_HOST: http://localhost:5050
      RELYING_PARTY_URL: "http://localhost:8080"
      BROWSER: ${BROWSER:-chromium}
    volumes:
      - ./reports:/reports
    network_mode: "host"

  ipv-core-stub:
    build:
      context: ../../../ipv-stubs/di-ipv-core-stub/
      dockerfile: Dockerfile-arm64
      target: nodynatrace
      no_cache: true
    container_name: ipv-core-stub-hmrc
    ports:
      - "8085:8085"
    environment:
      - CORE_STUB_CONFIG_FILE=/app/config/di-ipv-config.yaml
    env_file:
      - ../../../ipv-config/stubs/di-ipv-core-stub/.env
    volumes:
      - ../../../ipv-config/stubs/di-ipv-core-stub:/app/config
      - ../browser/di-ipv-config.yaml:/app/config/di-ipv-config.yaml
    profiles:
      - core-stub
